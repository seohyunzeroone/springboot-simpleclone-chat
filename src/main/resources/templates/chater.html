<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Chat</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
        #log { border: 1px solid #ddd; height: 320px; overflow-y: auto; padding: 8px; border-radius: 8px; }
        #controls { margin-top: 10px; display: flex; gap: 8px; }
        #msg { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 8px 12px; border: 0; border-radius: 6px; background: #2f6feb; color: white; cursor: pointer; }
        button.secondary { background: #777; }
        .sys { color: #7a7a7a; font-style: italic; }
    </style>
</head>
<body>
<h2>WebSocket Chat</h2>

<div id="log"></div>

<div id="controls">
    <input id="msg" type="text" placeholder="메시지를 입력하세요…" />
    <button id="sendBtn">보내기</button>
    <button id="leaveBtn" class="secondary">채팅방 나가기</button>
</div>

<script>
    const logEl = document.getElementById('log');
    const msgEl = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const leaveBtn = document.getElementById('leaveBtn');

    // ===== 설정 =====
    const wsPath = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/chat';
    const keepAliveIntervalMs = 30000; // 30초에 한 번 ping
    const maxBackoffMs = 30000;        // 재연결 최대 대기 30초

    // ===== 상태 =====
    let ws = null;
    let leaving = false;           // 사용자가 '나가기' 눌렀는지 여부
    let reconnectAttempt = 0;      // 재연결 시도 회수
    let keepAliveTimer = null;

    function appendLine(text, cls = '') {
        const p = document.createElement('div');
        if (cls) p.className = cls;
        p.textContent = text;
        logEl.appendChild(p);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function startKeepAlive() {
        stopKeepAlive();
        keepAliveTimer = setInterval(() => {
            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('__ping__'); // 서버에서 별도 처리 안 해도 OK
                }
            } catch (e) {}
        }, keepAliveIntervalMs);
    }

    function stopKeepAlive() {
        if (keepAliveTimer) {
            clearInterval(keepAliveTimer);
            keepAliveTimer = null;
        }
    }

    function connect() {
        ws = new WebSocket(wsPath);

        ws.onopen = () => {
            reconnectAttempt = 0;
            appendLine('[연결됨]', 'sys');
            startKeepAlive();
        };

        ws.onmessage = (evt) => {
            if (evt.data === '__pong__') return; // 혹시 서버에서 pong 주면 무시
            appendLine(evt.data);
        };

        ws.onclose = (evt) => {
            stopKeepAlive();
            if (leaving) {
                appendLine('[연결 종료]', 'sys');
                return;
            }
            appendLine(`[연결 끊김 - 자동 재연결 시도] (code=${evt.code})`, 'sys');
            scheduleReconnect();
        };

        ws.onerror = () => {
            // 일부 브라우저는 error 후 close가 이어짐
            appendLine('[오류 발생]', 'sys');
        };
    }

    function scheduleReconnect() {
        // 지수 백오프
        reconnectAttempt++;
        const wait = Math.min(1000 * Math.pow(2, reconnectAttempt), maxBackoffMs);
        setTimeout(() => {
            if (!leaving) connect();
        }, wait);
    }

    function sendMessage() {
        const text = msgEl.value.trim();
        if (!text) return;
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(text);
            msgEl.value = '';
        } else {
            appendLine('[아직 연결되지 않았습니다. 잠시 후 다시 시도하세요.]', 'sys');
        }
    }

    // UI 핸들러
    sendBtn.addEventListener('click', sendMessage);
    msgEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    leaveBtn.addEventListener('click', () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            leaving = true;
            ws.close(1000, 'client-leave'); // 정상 종료
        }
    });

    // 브라우저 탭 닫기/새로고침 경고(원하면 활성화)
    window.addEventListener('beforeunload', (e) => {
        if (!leaving) {
            // 경고 표시(일부 브라우저는 커스텀 문구 미지원)
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // 초기 연결
    connect();
</script>
</body>
</html>
