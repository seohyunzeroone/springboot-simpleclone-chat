<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>
<body>
<h3>채팅방</h3>
<div id="msgArea" style="height:300px; overflow-y:auto; border:1px solid #aaa; padding:5px; margin-bottom:10px;"></div>
<input type="text" id="msg" placeholder="메시지를 입력하세요">
<button id="button-send">전송</button>

<script>
    (function () {
        // ✅ 닉네임을 반드시 먼저 받아오도록 함수로 분리
        function askUsername() {
            let name = '';
            // null(취소)일 때도 다시 물어보도록 처리
            while (!name || !name.trim()) {
                name = prompt('닉네임을 입력하세요');
            }
            // 콜론(:) 제거 (프로토콜 구분자 충돌 방지)
            return name.replace(/:/g, '');
        }

        let username;

        // ✅ DOM이 준비되면 실행
        $(function () {
            if (!username) username = askUsername();          // 첫 진입 시
            startChat(username);                               // 닉네임 받은 후에만 연결
        });

        // ✅ bfcache(뒤로가기 캐시)로 돌아온 경우에도 다시 물어보도록
        window.addEventListener('pageshow', function (e) {
            if (e.persisted || (performance && performance.getEntriesByType)) {
                // 이미 연결돼 있더라도 재진입 시 닉네임 재설정 원한다면 아래 주석 해제
            }
        });

        // ✅ WebSocket 연결/핸들러는 닉네임 받은 뒤에만 세팅
        function startChat(username) {
            // WebSocket 연결 (http/https 자동 구분)
            const wsScheme = (location.protocol === 'https:') ? 'wss://' : 'ws://';
            const wsUrl = wsScheme + location.host + '/ws/chat';
            const websocket = new WebSocket(wsUrl);

            websocket.onopen = function () {
                // 연결 직후 안내 메시지 전송
                sendRaw(username + ': 님이 입장하셨습니다.');
            };

            websocket.onmessage = function (e) {
                onMessage(e.data);
            };

            websocket.onclose = function () {
                appendMsg('system', '연결이 종료되었습니다.');
            };

            // 메시지 전송 (버튼 또는 엔터키)
            $('#button-send').off('click').on('click', send);
            $('#msg').off('keydown').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    send();
                }
            });

            function send() {
                const input = $('#msg');
                const text = input.val().trim();
                if (!text) return;
                sendRaw(username + ':' + text);
                input.val('').focus();
            }

            function sendRaw(payload) {
                if (websocket.readyState === WebSocket.OPEN) {
                    websocket.send(payload);
                }
            }

            // 서버에서 메시지 수신 시 출력
            function onMessage(data) {
                const idx = data.indexOf(':');
                let sender = '', message = data;
                if (idx > -1) {
                    sender = data.substring(0, idx).trim();
                    message = data.substring(idx + 1).trim();
                }

                if (sender === username) {
                    appendMsg('me', `${sender} : ${message}`);
                } else {
                    appendMsg('other', `${sender} : ${message}`);
                }
            }

            // 메시지 출력 함수
            function appendMsg(type, text) {
                const color = type === 'me' ? '#e6e6e6' : '#fff3cd';
                const div = `<div style="background:${color}; margin:3px; padding:5px; border-radius:4px;">${escapeHtml(text)}</div>`;
                $('#msgArea').append(div);
                const box = document.getElementById('msgArea');
                box.scrollTop = box.scrollHeight;
            }

            // HTML 특수문자 이스케이프 (보안)
            function escapeHtml(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }
        }
    })();
</script>
</body>
</html>
