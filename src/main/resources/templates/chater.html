<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Chat</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
        #loginScreen { text-align: center; padding: 60px 20px; }
        #loginScreen h2 { margin-bottom: 20px; }
        #loginScreen input { padding: 12px; width: 300px; max-width: 100%; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #loginScreen button { margin-top: 12px; padding: 12px 24px; border: 0; border-radius: 6px; background: #2f6feb; color: white; cursor: pointer; font-size: 16px; }
        #chatScreen { display: none; }
        #log { border: 1px solid #ddd; height: 320px; overflow-y: auto; padding: 8px; border-radius: 8px; }
        #controls { margin-top: 10px; display: flex; gap: 8px; }
        #msg { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        button { padding: 8px 12px; border: 0; border-radius: 6px; background: #2f6feb; color: white; cursor: pointer; }
        button.secondary { background: #777; }
        .sys { color: #7a7a7a; font-style: italic; }
        .u { font-weight: 700; margin-right: 4px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <h2>WebSocket Chat</h2>
    <p>채팅에 참여하려면 닉네임을 입력하세요</p>
    <input id="usernameInput" type="text" placeholder="닉네임을 입력하세요" maxlength="20" />
    <br>
    <button id="joinBtn">입장하기</button>
</div>

<div id="chatScreen">
    <h2>WebSocket Chat</h2>
    <div id="log"></div>
    <div id="controls">
        <input id="msg" type="text" placeholder="메시지를 입력하세요…" />
        <button id="sendBtn">보내기</button>
        <button id="leaveBtn" class="secondary">채팅방 나가기</button>
    </div>
</div>

<script>
    const loginScreen = document.getElementById('loginScreen');
    const chatScreen = document.getElementById('chatScreen');
    const usernameInput = document.getElementById('usernameInput');
    const joinBtn = document.getElementById('joinBtn');
    const logEl = document.getElementById('log');
    const msgEl = document.getElementById('msg');
    const sendBtn = document.getElementById('sendBtn');
    const leaveBtn = document.getElementById('leaveBtn');

    const wsPath = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/chat';
    const keepAliveIntervalMs = 30000;
    const maxBackoffMs = 30000;

    let ws = null;
    let leaving = false;
    let reconnectAttempt = 0;
    let keepAliveTimer = null;
    let username = '';
    let sentJoinForThisConnection = false;

    function appendLine(text, cls = '') {
        const idx = text.indexOf(':');
        const wrap = document.createElement('div');
        if (cls) wrap.className = cls;

        if (idx > 0) {
            const u = text.slice(0, idx);
            const m = text.slice(idx + 1).trimStart();
            const un = document.createElement('span');
            un.className = 'u';
            un.textContent = u + ':';
            const msg = document.createElement('span');
            msg.textContent = ' ' + m;
            wrap.appendChild(un);
            wrap.appendChild(msg);
        } else {
            wrap.textContent = text;
        }
        logEl.appendChild(wrap);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function startKeepAlive() {
        stopKeepAlive();
        keepAliveTimer = setInterval(() => {
            try { if (ws && ws.readyState === WebSocket.OPEN) ws.send('__ping__'); } catch (_) {}
        }, keepAliveIntervalMs);
    }
    function stopKeepAlive() { if (keepAliveTimer) { clearInterval(keepAliveTimer); keepAliveTimer = null; } }

    function connect() {
        ws = new WebSocket(wsPath);

        ws.onopen = () => {
            reconnectAttempt = 0;
            appendLine('[연결됨]', 'sys');
            startKeepAlive();
            if (username && !sentJoinForThisConnection) {
                try { ws.send(`${username}: 님이 입장하셨습니다.`); } catch (_) {}
                sentJoinForThisConnection = true;
            }
        };

        ws.onmessage = (evt) => {
            if (evt.data === '__ping__' || evt.data === '__pong__') return;
            appendLine(evt.data);
        };

        ws.onclose = (evt) => {
            stopKeepAlive();
            sentJoinForThisConnection = false;
            if (leaving) { appendLine('[연결 종료]', 'sys'); return; }
            appendLine(`[연결 끊김 - 자동 재연결 시도] (code=${evt.code})`, 'sys');
            scheduleReconnect();
        };

        ws.onerror = () => appendLine('[오류 발생]', 'sys');
    }

    function scheduleReconnect() {
        reconnectAttempt++;
        const wait = Math.min(1000 * Math.pow(2, reconnectAttempt), maxBackoffMs);
        setTimeout(() => { if (!leaving) connect(); }, wait);
    }

    function sendMessage() {
        const text = msgEl.value.trim();
        if (!text || !username) return;
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(`${username}: ${text}`);
            msgEl.value = '';
        } else {
            appendLine('[아직 연결되지 않았습니다. 잠시 후 다시 시도하세요.]', 'sys');
        }
    }

    function joinChat() {
        const name = usernameInput.value.trim();
        if (!name) {
            alert('닉네임을 입력해주세요.');
            return;
        }
        username = name;
        loginScreen.style.display = 'none';
        chatScreen.style.display = 'block';
        msgEl.focus();
        connect();
    }

    // UI 이벤트
    joinBtn.addEventListener('click', joinChat);
    usernameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') joinChat(); });

    sendBtn.addEventListener('click', sendMessage);
    msgEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

    leaveBtn.addEventListener('click', () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            try { ws.send(`${username}: 님이 퇴장하셨습니다.`); } catch (_){}
            leaving = true;
            ws.close(1000, 'client-leave');
        }
        // 로그인 화면으로 돌아가기
        chatScreen.style.display = 'none';
        loginScreen.style.display = 'block';
        usernameInput.value = '';
        username = '';
        leaving = false;
        sentJoinForThisConnection = false;
    });

    // 초기 포커스
    usernameInput.focus();
</script>
</body>
</html>